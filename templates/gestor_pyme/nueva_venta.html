<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Venta - Gestor PyME</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .product-row td:first-child { min-width: 220px; }
        .low-stock { font-weight:700; }
        .table-fixed thead { position: sticky; top: 0; z-index: 1; }
        .price { white-space: nowrap; }
        .summary-card { position: sticky; top: 1rem; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">Gestor PyME</a>
    <div class="collapse navbar-collapse">
      <form class="ms-auto d-flex" method="GET" action="">
        <input class="form-control me-2" name="busqueda" type="search" placeholder="Buscar producto..." aria-label="Buscar">
        <button class="btn btn-outline-light" type="submit">Buscar</button>
      </form>
    </div>
  </div>
</nav>

<div class="container">
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-warning{% endif %} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="row g-4">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Productos</h5>

          <form id="venta-form" method="POST" novalidate>
            {% csrf_token %} <input type="hidden" name="vendedor" value="{{ vendedor.id }}">
            <div class="table-responsive">
              <table class="table table-striped table-hover table-fixed align-middle">
                <thead class="table-dark">
                  <tr>
                    <th>Producto</th>
                    <th class="text-end">Precio</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center" style="width: 140px;">Cantidad</th>
                  </tr>
                </thead>
                <tbody>
                  {% for producto in productos %}
                  <tr class="product-row">
                    <td>
                      <div class="d-flex align-items-center">
                        <!-- opcional: <img src="{{ producto.imagen_url }}" class="me-3 rounded" style="width:48px; height:48px; object-fit:cover;"> -->
                        <div>
                          <div class="fw-semibold">{{ producto.nombre }}</div>
                          {% if producto.descripcion %}<small class="text-muted">{{ producto.descripcion }}</small>{% endif %}
                        </div>
                      </div>
                    </td>
                    <td class="text-end price">${{ producto.precio_venta|floatformat:2 }}</td>
                    <td class="text-center">
                      {% if producto.stock <= 5 %}
                        <span class="badge bg-danger low-stock">{{ producto.stock }} disponible</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ producto.stock }}</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <input type="number" name="cantidad_{{ producto.id }}" class="form-control cantidad-input" min="0" max="{{ producto.stock }}" value="0" data-precio="{{ producto.precio_venta|floatformat:2 }}">
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="4" class="text-center text-muted">No hay productos disponibles</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end mt-3">
              <button type="button" id="finalizar-btn" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#confirmModal" disabled>Finalizar Venta</button>
            </div>

            <!-- Confirmación modal -->
            <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirmar venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    <p>Está a punto de registrar una venta por <strong>$<span id="modal-total">0.00</span></strong>.</p>
                    <p class="mb-0 text-muted">Revise cantidades y stock antes de confirmar.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar y guardar</button>
                  </div>
                </div>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm summary-card">
        <div class="card-body">
          <h5 class="card-title">Resumen de Venta</h5>
          <p class="mb-1 text-muted">Vendedor</p>
          <div class="mb-3">{{ vendedor.get_full_name|default:vendedor.username }}</div>

          <ul class="list-group mb-3" id="lista-resumen">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Artículos
              <span id="cantidad-total" class="badge bg-primary rounded-pill">0</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Total
              <strong>$<span id="total-venta">0.00</span></strong>
            </li>
          </ul>

          <small class="text-muted">Los precios se actualizan en tiempo real según las cantidades ingresadas.</small>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const cantidadInputs = document.querySelectorAll('.cantidad-input');
  const totalSpan = document.getElementById('total-venta');
  const cantidadBadge = document.getElementById('cantidad-total');
  const finalizarBtn = document.getElementById('finalizar-btn');
  const modalTotal = document.getElementById('modal-total');

  function calcularTotal() {
    let total = 0;
    let items = 0;
    cantidadInputs.forEach(input => {
      const cantidad = parseInt(input.value, 10) || 0;
      const precio = parseFloat(input.dataset.precio) || 0;
      if (cantidad > 0) items += cantidad;
      total += cantidad * precio;
    });
    totalSpan.innerText = total.toFixed(2);
    cantidadBadge.innerText = items;
    modalTotal.innerText = total.toFixed(2);
    finalizarBtn.disabled = total <= 0;
  }

  cantidadInputs.forEach(input => input.addEventListener('input', () => {
    // garantiza valores válidos
    const max = parseInt(input.max, 10) || Infinity;
    if (parseInt(input.value, 10) > max) input.value = max;
    if (parseInt(input.value, 10) < 0) input.value = 0;
    calcularTotal();
  }));

  // inicializa al cargar
  calcularTotal();

  // Previene el envío accidental por enter (opcional)
  document.getElementById('venta-form').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.tagName === 'INPUT') e.preventDefault();
  });
</script>
</body>
</html>