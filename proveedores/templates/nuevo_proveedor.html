{% extends 'base/base.html' %}

{% block title %}Proveedores{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- Panel de Productos -->
    <div class="pos-products">
        <form class="d-flex mb-3" method="GET" action="">
            <div class="input-group">
                <input name="busqueda" class="form-control form-control-lg" type="search" 
                       placeholder="Buscar producto por nombre, código o descripción..." 
                       value="{{ request.GET.busqueda|default:'' }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>

        <form id="venta-form" method="POST" class="h-100">
            {% csrf_token %}
            <input type="hidden" name="vendedor" value="{{ vendedor.id }}">
            
            <div class="product-grid">
                {% for producto in productos %}
                <div class="product-card position-relative">
                    <span class="stock-badge badge {% if producto.stock <= producto.stock_minimo %}bg-danger{% else %}bg-success{% endif %}">
                        Stock: {{ producto.stock }}
                    </span>
                    
                    <h5 class="product-title mb-2">{{ producto.nombre }}</h5>
                    {% if producto.descripcion %}
                        <p class="small text-muted mb-2">{{ producto.descripcion|truncatechars:50 }}</p>
                    {% endif %}
                    {% if producto.categoria %}
                        <div class="badge bg-secondary mb-2">{{ producto.categoria }}</div>
                    {% endif %}
                    
                    <div class="price mb-3">${{ producto.precio_venta }}</div>
                    
                    <div class="qty-control">
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="adjustQty('cantidad_{{ producto.id }}', -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="form-control text-center product-qty"
                                   name="cantidad_{{ producto.id }}" 
                                   id="cantidad_{{ producto.id }}"
                                   value="0" min="0" max="{{ producto.stock }}"
                                   onchange="validateQty(this, {{ producto.stock }})"
                                   oninput="updateCart()"
                                   data-price="{{ producto.precio_venta }}"
                                   data-name="{{ producto.nombre }}">
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="adjustQty('cantidad_{{ producto.id }}', 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-5 w-100">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="lead mt-3">No se encontraron productos</p>
                </div>
                {% endfor %}
            </div>
        </form>
    </div>

    <!-- Panel del Carrito -->
    <div class="pos-cart">
        <div class="p-3 border-bottom">
            <h4 class="mb-0">Carrito de Compras</h4>
        </div>

        <div class="pos-cart-items p-3" id="cart-items">
            <!-- Los items del carrito se agregarán aquí dinámicamente -->
        </div>

        <div class="pos-cart-total">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="subtotal-amount">$0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
                <span class="h5">Total:</span>
                <span class="h5" id="total-amount">$0.00</span>
            </div>
            
            <button type="submit" form="venta-form" class="btn btn-primary btn-lg w-100" id="confirm-btn" disabled>
                <i class="bi bi-check2-circle me-2"></i>
                Finalizar Venta
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const formatter = new Intl.NumberFormat('es-AR', {
    style: 'currency',
    currency: 'ARS'
});

function adjustQty(inputId, delta) {
    const input = document.getElementById(inputId);
    const newValue = parseInt(input.value || 0) + delta;
    input.value = Math.max(0, Math.min(newValue, parseInt(input.max)));
    updateCart();
}

function validateQty(input, max) {
    input.value = Math.max(0, Math.min(parseInt(input.value || 0), max));
}

function updateCart() {
    const cartItems = document.getElementById('cart-items');
    cartItems.innerHTML = '';
    
    let total = 0;
    let hasItems = false;

    document.querySelectorAll('.product-qty').forEach(input => {
        const qty = parseInt(input.value || 0);
        if (qty > 0) {
            hasItems = true;
            const price = parseFloat(input.dataset.price);
            const subtotal = qty * price;
            total += subtotal;

            const itemElement = document.createElement('div');
            itemElement.className = 'mb-3 border-bottom pb-2';
            itemElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${input.dataset.name}</h6>
                        <div class="text-muted small">
                            ${qty} x ${formatter.format(price)}
                        </div>
                    </div>
                    <div class="h6 mb-0">
                        ${formatter.format(subtotal)}
                    </div>
                </div>
            `;
            cartItems.appendChild(itemElement);
        }
    });

    if (!hasItems) {
        cartItems.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-cart3 display-4"></i>
                <p class="mt-2">El carrito está vacío</p>
            </div>
        `;
    }

    document.getElementById('subtotal-amount').textContent = formatter.format(total);
    document.getElementById('total-amount').textContent = formatter.format(total);
    document.getElementById('confirm-btn').disabled = !hasItems;
}

// Inicializar el carrito al cargar la página
document.addEventListener('DOMContentLoaded', updateCart);
</script>
{% endblock %}